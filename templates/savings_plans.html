{% extends "base.html" %}
{% block title %}Savings Plans & Reservations - AWS Cost Optimizer{% endblock %}
{% block page_title %}<i class="bi bi-piggy-bank"></i> Savings Plans & Reserved Instances{% endblock %}

{% block content %}
<!-- Coverage & Utilization Summary -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">SP Utilization</h6>
                <h2 class="text-info">{{ utilization.utilization_pct|default('0') }}%</h2>
                <small class="text-muted">Last 30 days</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">Net Savings</h6>
                <h2 class="text-success">${{ utilization.net_savings|default('0') }}</h2>
                <small class="text-muted">From Savings Plans</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">Active Savings Plans</h6>
                <h2 class="text-warning">{{ plans|length if plans and plans[0] is mapping and 'error' not in plans[0] else 0 }}</h2>
                <small class="text-muted">Currently active</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-dark border-secondary h-100">
            <div class="card-body text-center">
                <h6 class="text-muted">Reserved Instances</h6>
                <h2 class="text-primary">{{ ri_data|length if ri_data and ri_data[0] is mapping and 'error' not in ri_data[0] else 0 }}</h2>
                <small class="text-muted">Active RIs (EC2 + RDS)</small>
            </div>
        </div>
    </div>
</div>

<!-- Savings Plans Table -->
<div class="card bg-dark border-secondary mb-4">
    <div class="card-header border-secondary">
        <i class="bi bi-piggy-bank"></i> Active Savings Plans
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover mb-0">
                <thead>
                    <tr><th>Plan ID</th><th>Type</th><th>State</th><th>Payment</th><th>Commitment/hr</th><th>Start</th><th>End</th><th>Region</th></tr>
                </thead>
                <tbody>
                {% for sp in plans or [] %}
                {% if sp is mapping and 'error' not in sp %}
                <tr>
                    <td><code>{{ sp.id[:12] }}...</code></td>
                    <td><span class="badge bg-info">{{ sp.type }}</span></td>
                    <td><span class="badge {{ 'bg-success' if sp.state == 'active' else 'bg-secondary' }}">{{ sp.state }}</span></td>
                    <td>{{ sp.payment_option }}</td>
                    <td>${{ sp.commitment_per_hour }}</td>
                    <td>{{ sp.start[:10] if sp.start else '—' }}</td>
                    <td>{{ sp.end[:10] if sp.end else '—' }}</td>
                    <td>{{ sp.region or 'All' }}</td>
                </tr>
                {% endif %}
                {% else %}
                <tr><td colspan="8" class="text-center text-muted py-3">No active Savings Plans found</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Reserved Instances Table -->
<div class="card bg-dark border-secondary mb-4">
    <div class="card-header border-secondary">
        <i class="bi bi-bookmark-star"></i> Reserved Instances
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover mb-0">
                <thead>
                    <tr><th>RI ID</th><th>Type</th><th>Count</th><th>State</th><th>Offering</th><th>Class</th><th>Start</th><th>End</th><th>Fixed Price</th></tr>
                </thead>
                <tbody>
                {% for ri in ri_data or [] %}
                {% if ri is mapping and 'error' not in ri %}
                <tr>
                    <td><code>{{ ri.id[:12] }}...</code></td>
                    <td><span class="badge bg-secondary">{{ ri.type }}</span></td>
                    <td>{{ ri.count }}</td>
                    <td><span class="badge {{ 'bg-success' if ri.state == 'active' else 'bg-secondary' }}">{{ ri.state }}</span></td>
                    <td>{{ ri.offering_type }}</td>
                    <td>{{ ri.offering_class }}</td>
                    <td>{{ ri.start[:10] if ri.start else '—' }}</td>
                    <td>{{ ri.end[:10] if ri.end else '—' }}</td>
                    <td>${{ ri.fixed_price }}</td>
                </tr>
                {% endif %}
                {% else %}
                <tr><td colspan="9" class="text-center text-muted py-3">No active Reserved Instances found</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Coverage -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <i class="bi bi-shield-fill-check"></i> Savings Plan Coverage
            </div>
            <div class="card-body">
                {% for c in coverage or [] %}
                {% if c is mapping and 'error' not in c %}
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>{{ c.period_start }} → {{ c.period_end }}</small>
                        <strong>{{ c.coverage_pct }}%</strong>
                    </div>
                    <div class="progress bg-secondary" style="height:20px;">
                        <div class="progress-bar bg-success" style="width:{{ c.coverage_pct }}%">{{ c.coverage_pct }}%</div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">Covered: ${{ c.spend_covered }}</small>
                        <small class="text-muted">On-Demand: ${{ c.on_demand_cost }}</small>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <p class="text-muted mb-0">No coverage data available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-dark border-secondary">
            <div class="card-header border-secondary">
                <i class="bi bi-bar-chart-line"></i> Savings Plan Utilization Details
            </div>
            <div class="card-body">
                {% if utilization and utilization is mapping and 'error' not in utilization %}
                <div class="row text-center mb-3">
                    <div class="col">
                        <small class="text-muted d-block">Total Commitment</small>
                        <strong>${{ utilization.total_commitment }}</strong>
                    </div>
                    <div class="col">
                        <small class="text-muted d-block">Used</small>
                        <strong class="text-success">${{ utilization.used_commitment }}</strong>
                    </div>
                    <div class="col">
                        <small class="text-muted d-block">Unused</small>
                        <strong class="text-danger">${{ utilization.unused_commitment }}</strong>
                    </div>
                </div>
                <div class="progress bg-secondary" style="height:24px;">
                    <div class="progress-bar bg-info" style="width:{{ utilization.utilization_pct }}%">
                        {{ utilization.utilization_pct }}% Utilized
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <small class="text-muted">On-Demand Equivalent: ${{ utilization.on_demand_equivalent }}</small>
                </div>
                {% else %}
                <p class="text-muted mb-0">No utilization data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- SP Purchase Recommendations -->
<div class="card bg-dark border-secondary mb-4">
    <div class="card-header border-secondary">
        <i class="bi bi-lightbulb-fill"></i> Savings Plan Purchase Recommendations
        <small class="text-muted">(Compute SP, 1-Year, No Upfront)</small>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover mb-0">
                <thead>
                    <tr><th>Hourly Commitment</th><th>Est. Monthly Savings</th><th>Savings %</th><th>On-Demand Cost</th><th>SP Cost</th><th>Avg Hourly OD Spend</th></tr>
                </thead>
                <tbody>
                {% if sp_recommendations and sp_recommendations is mapping %}
                {% for rec in sp_recommendations.recommendations or [] %}
                <tr>
                    <td>${{ rec.hourly_commitment }}</td>
                    <td class="text-success">${{ rec.estimated_monthly_savings }}</td>
                    <td>{{ rec.estimated_savings_pct }}%</td>
                    <td>${{ rec.estimated_on_demand_cost }}</td>
                    <td>${{ rec.estimated_sp_cost }}</td>
                    <td>${{ rec.current_avg_hourly_od }}</td>
                </tr>
                {% else %}
                <tr><td colspan="6" class="text-center text-muted py-3">No purchase recommendations available</td></tr>
                {% endfor %}
                {% else %}
                <tr><td colspan="6" class="text-center text-muted py-3">Unable to fetch recommendations</td></tr>
                {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
