{% extends "base.html" %}
{% block title %}AWS Accounts - AWS Cost Optimizer{% endblock %}
{% block page_title %}<i class="bi bi-cloud-plus"></i> AWS Account Integrations{% endblock %}

{% block content %}
<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1">Connected AWS Accounts</h4>
        <p class="text-muted mb-0">Manage your AWS account integrations. Connect via IAM Role (recommended) or Access Keys.</p>
    </div>
    <div class="d-flex gap-2">
        <form method="post" action="{{ url_for('accounts_discover_org') }}" class="d-inline">
            <button class="btn btn-outline-info btn-sm" type="submit">
                <i class="bi bi-diagram-3"></i> Discover from Organizations
            </button>
        </form>
        <form method="post" action="{{ url_for('accounts_refresh_all') }}" class="d-inline">
            <button class="btn btn-outline-warning btn-sm" type="submit">
                <i class="bi bi-arrow-clockwise"></i> Refresh All
            </button>
        </form>
        <a href="{{ url_for('accounts_add') }}" class="btn btn-success btn-sm">
            <i class="bi bi-plus-lg"></i> Add Account
        </a>
    </div>
</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}

{% if not accounts %}
<!-- Empty state -->
<div class="card bg-dark border-secondary">
    <div class="card-body text-center py-5">
        <i class="bi bi-cloud-plus fs-1 text-muted mb-3 d-block"></i>
        <h5>No AWS Accounts Connected</h5>
        <p class="text-muted mb-4">Connect your first AWS account to start analyzing costs and getting optimization recommendations.</p>
        <div class="row justify-content-center g-3 mb-4">
            <div class="col-md-4">
                <div class="card bg-dark border-info">
                    <div class="card-body text-start">
                        <h6 class="text-info"><i class="bi bi-shield-lock"></i> IAM Role (Recommended)</h6>
                        <small class="text-muted">Deploy a CloudFormation stack in the target account to create a read-only cross-account role. No keys to manage.</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark border-warning">
                    <div class="card-body text-start">
                        <h6 class="text-warning"><i class="bi bi-key"></i> Access Keys</h6>
                        <small class="text-muted">Provide IAM user access keys with read-only permissions. Simpler but requires key rotation.</small>
                    </div>
                </div>
            </div>
        </div>
        <a href="{{ url_for('accounts_add') }}" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Add Your First Account
        </a>
    </div>
</div>
{% else %}

<!-- Accounts Grid -->
<div class="row g-3">
    {% for acct in accounts %}
    <div class="col-md-6 col-lg-4">
        <div class="card bg-dark border-secondary h-100 {{ 'border-info' if acct.is_active else '' }}">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    {% if acct.status == 'connected' %}
                    <span class="status-dot bg-success" title="Connected"></span>
                    {% elif acct.status == 'error' %}
                    <span class="status-dot bg-danger" title="Error"></span>
                    {% else %}
                    <span class="status-dot bg-warning" title="Pending"></span>
                    {% endif %}
                    <strong>{{ acct.name }}</strong>
                    {% if acct.is_active %}
                    <span class="badge bg-info">Active</span>
                    {% endif %}
                </div>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots-vertical"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                        {% if not acct.is_active %}
                        <li>
                            <form method="post" action="{{ url_for('accounts_activate', account_id=acct.id) }}">
                                <button class="dropdown-item" type="submit"><i class="bi bi-check-circle"></i> Set as Active</button>
                            </form>
                        </li>
                        {% endif %}
                        <li><a class="dropdown-item" href="{{ url_for('accounts_edit', account_id=acct.id) }}"><i class="bi bi-pencil"></i> Edit</a></li>
                        <li>
                            <form method="post" action="{{ url_for('accounts_refresh', account_id=acct.id) }}">
                                <button class="dropdown-item" type="submit"><i class="bi bi-arrow-clockwise"></i> Test Connection</button>
                            </form>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="post" action="{{ url_for('accounts_delete', account_id=acct.id) }}" onsubmit="return confirm('Remove this account?')">
                                <button class="dropdown-item text-danger" type="submit"><i class="bi bi-trash"></i> Remove</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <small class="text-muted d-block">Account ID</small>
                    <code>{{ acct.aws_account_id }}</code>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Auth Method</small>
                    {% if acct.auth_type == 'iam_role' %}
                    <span class="badge bg-info"><i class="bi bi-shield-lock"></i> IAM Role</span>
                    {% else %}
                    <span class="badge bg-warning"><i class="bi bi-key"></i> Access Key</span>
                    {% endif %}
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Region</small>
                    {{ acct.region }}
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Connection Status</small>
                    {% if acct.status == 'connected' %}
                    <span class="text-success"><i class="bi bi-check-circle-fill"></i> Connected</span>
                    {% elif acct.status == 'error' %}
                    <span class="text-danger"><i class="bi bi-x-circle-fill"></i> Error</span>
                    <br><small class="text-muted">{{ acct.status_message[:80] }}{{ '...' if acct.status_message|length > 80 }}</small>
                    {% else %}
                    <span class="text-warning"><i class="bi bi-hourglass-split"></i> Pending</span>
                    {% endif %}
                </div>
                {% if acct.last_checked %}
                <small class="text-muted">Last checked: {{ acct.last_checked[:19] }}</small>
                {% endif %}
            </div>
            {% if not acct.is_active and acct.status == 'connected' %}
            <div class="card-footer border-secondary">
                <form method="post" action="{{ url_for('accounts_activate', account_id=acct.id) }}">
                    <button class="btn btn-outline-info btn-sm w-100" type="submit">
                        <i class="bi bi-arrow-right-circle"></i> Switch to this account
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}

    <!-- Add new card -->
    <div class="col-md-6 col-lg-4">
        <a href="{{ url_for('accounts_add') }}" class="card bg-dark border-secondary border-dashed h-100 text-decoration-none text-center d-flex align-items-center justify-content-center" style="min-height: 280px; border-style: dashed !important;">
            <div class="card-body">
                <i class="bi bi-plus-circle fs-1 text-muted"></i>
                <p class="text-muted mt-2 mb-0">Add Another Account</p>
            </div>
        </a>
    </div>
</div>
{% endif %}

<style>
.status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}
</style>
{% endblock %}
