{% extends "base.html" %}
{% block title %}Dashboard - AWS Cost Optimizer{% endblock %}
{% block page_title %}<i class="bi bi-speedometer2"></i> Cost Dashboard{% endblock %}

{% block content %}
<!-- ========== PERIOD SELECTOR ========== -->
<div class="period-selector-bar mb-4">
    <div class="d-flex flex-wrap align-items-center gap-2">
        <span class="period-label"><i class="bi bi-calendar3"></i> Period:</span>
        <div class="btn-group period-btn-group" role="group">
            <a href="/?period=7d" class="btn btn-sm {{ 'btn-accent active' if current_period == '7d' else 'btn-outline-secondary' }}">7 Days</a>
            <a href="/?period=14d" class="btn btn-sm {{ 'btn-accent active' if current_period == '14d' else 'btn-outline-secondary' }}">14 Days</a>
            <a href="/?period=30d" class="btn btn-sm {{ 'btn-accent active' if current_period == '30d' else 'btn-outline-secondary' }}">30 Days</a>
            <a href="/?period=last_month" class="btn btn-sm {{ 'btn-accent active' if current_period == 'last_month' else 'btn-outline-secondary' }}">Last Month</a>
            <a href="/?period=3m" class="btn btn-sm {{ 'btn-accent active' if current_period == '3m' else 'btn-outline-secondary' }}">3 Months</a>
            <a href="/?period=6m" class="btn btn-sm {{ 'btn-accent active' if current_period == '6m' else 'btn-outline-secondary' }}">6 Months</a>
            <a href="/?period=ytd" class="btn btn-sm {{ 'btn-accent active' if current_period == 'ytd' else 'btn-outline-secondary' }}">YTD</a>
            <a href="/?period=12m" class="btn btn-sm {{ 'btn-accent active' if current_period == '12m' else 'btn-outline-secondary' }}">12 Months</a>
        </div>
        <div class="vr mx-1" style="border-color: var(--glass-border);"></div>
        <form class="d-flex align-items-center gap-2 custom-range-form" method="get" action="/">
            <input type="hidden" name="period" value="custom">
            <label class="period-label mb-0" style="font-size:0.78rem;">From</label>
            <input type="date" name="start" class="form-control form-control-sm period-date-input" value="{{ period_start or '' }}">
            <label class="period-label mb-0" style="font-size:0.78rem;">To</label>
            <input type="date" name="end" class="form-control form-control-sm period-date-input" value="{{ period_end or '' }}">
            <button type="submit" class="btn btn-sm btn-outline-info"><i class="bi bi-search"></i> Go</button>
        </form>
    </div>
    {% if period_start and period_end %}
    <div class="mt-2">
        <small class="text-muted"><i class="bi bi-info-circle"></i> Showing data from <strong style="color:var(--accent-cyan);">{{ period_start }}</strong> to <strong style="color:var(--accent-cyan);">{{ period_end }}</strong>
        {% if summary and summary.period_days is defined %} ({{ summary.period_days }} days){% endif %}
        </small>
    </div>
    {% endif %}
</div>

<!-- ========== KPI CARDS with 3D tilt ========== -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card kpi-card kpi-cyan kpi-3d h-100" data-tilt>
            <div class="kpi-glow kpi-glow-cyan"></div>
            <div class="card-body position-relative">
                <div class="kpi-sparkline" id="sparkPeriod"></div>
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label">Period Spend</div>
                        <div class="kpi-value text-cyan kpi-counter" data-target="{{ summary.current_total|default(0) }}">${{ summary.current_total|default('0.00') }}</div>
                    </div>
                    <div class="kpi-icon-3d">
                        <i class="bi bi-currency-dollar"></i>
                    </div>
                </div>
                {% if summary and summary.pct_change is defined %}
                <span class="badge {{ 'bg-danger' if summary.pct_change > 0 else 'bg-success' }} mt-2 badge-glow">
                    <i class="bi {{ 'bi-arrow-up' if summary.pct_change > 0 else 'bi-arrow-down' }}"></i>
                    {{ summary.pct_change }}% vs prev period
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card kpi-orange kpi-3d h-100" data-tilt>
            <div class="kpi-glow kpi-glow-orange"></div>
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label">Daily Average</div>
                        <div class="kpi-value text-orange kpi-counter" data-target="{{ summary.daily_average|default(0) }}">${{ summary.daily_average|default('0.00') }}</div>
                    </div>
                    <div class="kpi-icon-3d kpi-icon-3d-orange">
                        <i class="bi bi-calendar-day"></i>
                    </div>
                </div>
                <small style="color: var(--text-muted);">Avg over selected period</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card kpi-purple kpi-3d h-100" data-tilt>
            <div class="kpi-glow kpi-glow-purple"></div>
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label">Top Service</div>
                        <div class="kpi-value text-purple" style="font-size:1.1rem;">{{ summary.top_service|default('N/A') }}</div>
                    </div>
                    <div class="kpi-icon-3d kpi-icon-3d-purple">
                        <i class="bi bi-trophy"></i>
                    </div>
                </div>
                <span style="color: var(--accent-purple);">${{ summary.top_service_cost|default('0.00') }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card kpi-card kpi-blue kpi-3d h-100" data-tilt>
            <div class="kpi-glow kpi-glow-blue"></div>
            <div class="card-body position-relative">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <div class="kpi-label">Previous Period</div>
                        <div class="kpi-value text-blue kpi-counter" data-target="{{ summary.previous_total|default(0) }}">${{ summary.previous_total|default('0.00') }}</div>
                    </div>
                    <div class="kpi-icon-3d kpi-icon-3d-blue">
                        <i class="bi bi-clock-history"></i>
                    </div>
                </div>
                <small style="color: var(--text-muted);">Comparison period</small>
            </div>
        </div>
    </div>
</div>

<!-- ========== COMPUTE OPTIMIZER SUMMARY ========== -->
{% if co_summary and co_summary.total_monthly_savings is defined %}
<div class="section-title"><i class="bi bi-cpu"></i> AWS Compute Optimizer Insights</div>
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card optimizer-card h-100">
            <div class="card-body text-center">
                <div class="optimizer-savings-ring">
                    <span class="optimizer-savings-value">${{ "%.2f"|format(co_summary.total_monthly_savings) }}</span>
                    <span class="optimizer-savings-label">potential savings/mo</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-8">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="card mini-stat h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-pc-display" style="color:var(--accent-cyan); font-size:1.2rem;"></i>
                            <span class="mini-stat-label">EC2</span>
                        </div>
                        <div class="mini-stat-value">{{ co_summary.ec2.count|default(0) }} findings</div>
                        <small style="color:var(--accent-cyan);">${{ "%.2f"|format(co_summary.ec2.savings|default(0)) }}/mo</small>
                        {% if co_summary.ec2.over_provisioned|default(0) > 0 %}
                        <div><span class="badge bg-warning mt-1">{{ co_summary.ec2.over_provisioned }} over-provisioned</span></div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mini-stat h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-device-hdd" style="color:var(--accent-orange); font-size:1.2rem;"></i>
                            <span class="mini-stat-label">EBS</span>
                        </div>
                        <div class="mini-stat-value">{{ co_summary.ebs.count|default(0) }} findings</div>
                        <small style="color:var(--accent-orange);">${{ "%.2f"|format(co_summary.ebs.savings|default(0)) }}/mo</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mini-stat h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-lightning" style="color:var(--accent-purple); font-size:1.2rem;"></i>
                            <span class="mini-stat-label">Lambda</span>
                        </div>
                        <div class="mini-stat-value">{{ co_summary.lambda.count|default(0) }} findings</div>
                        <small style="color:var(--accent-purple);">${{ "%.2f"|format(co_summary.get('lambda', {}).savings|default(0)) }}/mo</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mini-stat h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-arrow-repeat" style="color:var(--accent-blue); font-size:1.2rem;"></i>
                            <span class="mini-stat-label">Auto Scaling</span>
                        </div>
                        <div class="mini-stat-value">{{ co_summary.asg.count|default(0) }} findings</div>
                        <small style="color:var(--accent-blue);">${{ "%.2f"|format(co_summary.asg.savings|default(0)) }}/mo</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mini-stat h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center gap-2 mb-2">
                            <i class="bi bi-box" style="color:var(--accent-pink); font-size:1.2rem;"></i>
                            <span class="mini-stat-label">ECS</span>
                        </div>
                        <div class="mini-stat-value">{{ co_summary.ecs.count|default(0) }} findings</div>
                        <small style="color:var(--accent-pink);">${{ "%.2f"|format(co_summary.ecs.savings|default(0)) }}/mo</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card mini-stat h-100" style="border-color: rgba(6,214,160,0.3);">
                    <div class="card-body d-flex flex-column justify-content-center align-items-center">
                        <a href="/recommendations" class="btn btn-sm btn-outline-success">
                            <i class="bi bi-arrow-right"></i> View Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ========== DAILY COST TREND + SERVICE DOUGHNUT ========== -->
<div class="section-title"><i class="bi bi-activity"></i> Daily Spend Analysis</div>
<div class="row g-3 mb-4">
    <div class="col-md-8">
        <div class="card chart-card-3d">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up"></i> Daily Cost Trend</span>
                <div class="chart-type-switcher" data-chart-id="dailyCostChart">
                    <button class="chart-switch-btn active" data-type="line" title="Line"><i class="bi bi-graph-up"></i></button>
                    <button class="chart-switch-btn" data-type="bar" title="Bar"><i class="bi bi-bar-chart"></i></button>
                    <button class="chart-switch-btn" data-type="area" title="Area"><i class="bi bi-graph-down"></i></button>
                    <button class="chart-switch-btn" data-type="radar" title="Radar"><i class="bi bi-pentagon"></i></button>
                </div>
            </div>
            <div class="card-body chart-body-glow" style="height:340px;">
                <canvas id="dailyCostChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card chart-card-3d">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-pie-chart"></i> Cost by Service</span>
                <div class="chart-type-switcher" data-chart-id="serviceCostChart">
                    <button class="chart-switch-btn active" data-type="doughnut" title="Doughnut"><i class="bi bi-pie-chart"></i></button>
                    <button class="chart-switch-btn" data-type="pie" title="Pie"><i class="bi bi-circle-half"></i></button>
                    <button class="chart-switch-btn" data-type="bar" title="Bar"><i class="bi bi-bar-chart"></i></button>
                    <button class="chart-switch-btn" data-type="polarArea" title="Polar"><i class="bi bi-bullseye"></i></button>
                </div>
            </div>
            <div class="card-body chart-body-glow" style="height:340px;">
                <canvas id="serviceCostChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ========== COST DISTRIBUTION ========== -->
<div class="section-title"><i class="bi bi-globe2"></i> Cost Distribution (Console View)</div>
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card chart-card-3d">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-geo-alt"></i> Cost by Region</span>
                <div class="chart-type-switcher" data-chart-id="regionCostChart">
                    <button class="chart-switch-btn active" data-type="horizontalBar" title="H-Bar"><i class="bi bi-bar-chart-steps"></i></button>
                    <button class="chart-switch-btn" data-type="bar" title="Bar"><i class="bi bi-bar-chart"></i></button>
                    <button class="chart-switch-btn" data-type="doughnut" title="Doughnut"><i class="bi bi-pie-chart"></i></button>
                    <button class="chart-switch-btn" data-type="polarArea" title="Polar"><i class="bi bi-bullseye"></i></button>
                </div>
            </div>
            <div class="card-body chart-body-glow" style="height:340px;">
                <canvas id="regionCostChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-people"></i> Cost by Linked Account
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:340px; overflow-y:auto;">
                    <table class="table table-dark table-striped table-hover mb-0" style="font-size:0.82rem;">
                        <thead><tr><th>Account ID</th><th class="text-end">Cost (USD)</th><th style="width:35%">Share</th></tr></thead>
                        <tbody>
                            {% set total_acct = account_costs|sum(attribute='cost') if account_costs else 1 %}
                            {% for a in account_costs or [] %}
                            <tr>
                                <td><code>{{ a.account_id }}</code></td>
                                <td class="text-end">${{ "%.2f"|format(a.cost) }}</td>
                                <td>
                                    <div class="progress" style="height:16px;">
                                        <div class="progress-bar" style="width:{{ (a.cost / total_acct * 100)|round(1) }}%">
                                            {{ (a.cost / total_acct * 100)|round(1) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center py-3" style="color:var(--text-muted);">Single account or no data</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-receipt-cutoff"></i> Top Usage Types
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height:340px; overflow-y:auto;">
                    <table class="table table-dark table-striped table-hover mb-0" style="font-size:0.78rem;">
                        <thead><tr><th>Usage Type</th><th class="text-end">Cost</th></tr></thead>
                        <tbody>
                            {% for u in usage_type_costs or [] %}
                            <tr>
                                <td class="text-truncate" style="max-width:200px;" title="{{ u.usage_type }}">{{ u.usage_type }}</td>
                                <td class="text-end text-nowrap">${{ "%.2f"|format(u.cost) }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="2" class="text-center py-3" style="color:var(--text-muted);">No data</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== DAILY COST BY SERVICE (Stacked) ========== -->
<div class="section-title"><i class="bi bi-layers"></i> Daily Cost by Service</div>
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card chart-card-3d">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-stack"></i> Daily Service Cost Breakdown</span>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-info">Selected Period</span>
                    <div class="chart-type-switcher" data-chart-id="dailyServiceChart">
                        <button class="chart-switch-btn active" data-type="stackedArea" title="Stacked Area"><i class="bi bi-graph-down"></i></button>
                        <button class="chart-switch-btn" data-type="stackedBar" title="Stacked Bar"><i class="bi bi-bar-chart-fill"></i></button>
                        <button class="chart-switch-btn" data-type="line" title="Line"><i class="bi bi-graph-up"></i></button>
                    </div>
                </div>
            </div>
            <div class="card-body chart-body-glow" style="height:400px;">
                <canvas id="dailyServiceChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ========== MONTHLY COST BREAKDOWN ========== -->
<div class="section-title"><i class="bi bi-calendar3"></i> Monthly Cost Overview</div>
<div class="row g-3 mb-4">
    <div class="col-md-7">
        <div class="card chart-card-3d">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-bar-chart"></i> Monthly Cost Trend</span>
                <div class="chart-type-switcher" data-chart-id="monthlyCostChart">
                    <button class="chart-switch-btn active" data-type="bar" title="Bar"><i class="bi bi-bar-chart"></i></button>
                    <button class="chart-switch-btn" data-type="line" title="Line"><i class="bi bi-graph-up"></i></button>
                    <button class="chart-switch-btn" data-type="area" title="Area"><i class="bi bi-graph-down"></i></button>
                    <button class="chart-switch-btn" data-type="radar" title="Radar"><i class="bi bi-pentagon"></i></button>
                </div>
            </div>
            <div class="card-body chart-body-glow" style="height:340px;">
                <canvas id="monthlyCostChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-receipt"></i> Month-wise Spend Summary
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Total Cost</th>
                                <th class="text-end">Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set mc_totals = monthly_costs.totals if monthly_costs and monthly_costs.totals else [] %}
                            {% for m in mc_totals %}
                            <tr>
                                <td><i class="bi bi-calendar-month" style="color:var(--accent-cyan);"></i> {{ m.month }}</td>
                                <td class="text-end">${{ "%.2f"|format(m.cost) }}</td>
                                <td class="text-end">
                                    {% if loop.index > 1 %}
                                        {% set prev = mc_totals[loop.index0 - 1].cost %}
                                        {% if prev > 0 %}
                                            {% set change = ((m.cost - prev) / prev * 100)|round(1) %}
                                            <span class="badge {{ 'bg-danger' if change > 0 else 'bg-success' }}">
                                                <i class="bi {{ 'bi-arrow-up' if change > 0 else 'bi-arrow-down' }}"></i>
                                                {{ change }}%
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span style="color:var(--text-muted);">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="3" class="text-center py-3" style="color:var(--text-muted);">No monthly data available</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== MONTHLY COST BY SERVICE TABLE ========== -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-grid-3x3"></i> Monthly Cost by Service
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    {% set mc_services = monthly_costs.services if monthly_costs and monthly_costs.services else [] %}
                    {% set months_list = mc_totals|map(attribute='month')|list %}
                    {% set all_services = mc_services|map(attribute='service')|unique|list %}
                    <table class="table table-dark table-striped table-hover mb-0" style="font-size:0.82rem;">
                        <thead>
                            <tr>
                                <th>Service</th>
                                {% for mo in months_list %}
                                <th class="text-end">{{ mo }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for svc in all_services[:15] %}
                            <tr>
                                <td>{{ svc }}</td>
                                {% for mo in months_list %}
                                    {% set ns = namespace(cost=0) %}
                                    {% for item in mc_services if item.service == svc and item.month == mo %}
                                        {% set ns.cost = item.cost %}
                                    {% endfor %}
                                    <td class="text-end">${{ "%.2f"|format(ns.cost) }}</td>
                                {% endfor %}
                            </tr>
                            {% else %}
                            <tr><td colspan="{{ months_list|length + 1 }}" class="text-center py-3" style="color:var(--text-muted);">No data available</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== SERVICE BREAKDOWN TABLE + ANOMALIES ========== -->
<div class="section-title"><i class="bi bi-table"></i> Service Details & Anomalies</div>
<div class="row g-3 mb-4">
    <div class="col-md-7">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ul"></i> Service Cost Breakdown
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-striped table-hover mb-0">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Service</th>
                                <th class="text-end">Cost (USD)</th>
                                <th style="width:30%">Share</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set total_svc_cost = service_costs|sum(attribute='cost') if service_costs else 1 %}
                            {% for svc in service_costs or [] %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ svc.service }}</td>
                                <td class="text-end">${{ "%.2f"|format(svc.cost) }}</td>
                                <td>
                                    <div class="progress" style="height:18px;">
                                        <div class="progress-bar" style="width:{{ (svc.cost / total_svc_cost * 100)|round(1) }}%">
                                            {{ (svc.cost / total_svc_cost * 100)|round(1) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-exclamation-triangle"></i> Cost Anomalies
            </div>
            <div class="card-body">
                {% if anomalies %}
                {% for a in anomalies %}
                <div class="alert alert-warning py-2 px-3 mb-2">
                    <span class="anomaly-dot"></span><strong>{{ a.start_date }}</strong><br>
                    <small>Impact: ${{ a.total_impact }} | Actual: ${{ a.actual_spend }}</small>
                    {% if a.root_causes %}
                    <br><small style="color:var(--text-muted);">{{ a.root_causes[0].get('Service','') }} - {{ a.root_causes[0].get('Region','') }}</small>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <p class="mb-0" style="color:var(--text-muted);"><i class="bi bi-check-circle" style="color:var(--accent-cyan);"></i> No cost anomalies detected in the last 90 days.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ============================================================
// NEXT-GEN DASHBOARD ENGINE — Switchable Charts + 3D Effects
// ============================================================

// ---- Period params ----
const PERIOD_START = '{{ period_start or '' }}';
const PERIOD_END = '{{ period_end or '' }}';
function apiUrl(base) {
    if (PERIOD_START && PERIOD_END) return base + '?start=' + PERIOD_START + '&end=' + PERIOD_END;
    return base;
}

// ---- Chart.js Defaults ----
Chart.defaults.color = '#94a3b8';
Chart.defaults.borderColor = 'rgba(255,255,255,0.04)';
Chart.defaults.font.family = "'Inter', sans-serif";
const PALETTE = ['#06d6a0','#4cc9f0','#7b61ff','#f72585','#ff9e00','#fbbf24','#20c997','#0d6efd','#ef476f','#6c757d'];
const TOOLTIP_STYLE = {
    backgroundColor: 'rgba(10,14,23,0.95)', borderColor: 'rgba(6,214,160,0.3)', borderWidth: 1,
    titleColor: '#e2e8f0', bodyColor: '#06d6a0', titleFont: { weight: '700', size: 12 },
    cornerRadius: 10, padding: 12, displayColors: true,
    boxShadow: '0 8px 32px rgba(0,0,0,0.5)',
};

// ---- Store chart instances + raw data for re-rendering ----
const chartInstances = {};
const chartDataStore = {};

function destroyChart(id) {
    if (chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; }
}

function createGradient(ctx, color, h) {
    const g = ctx.createLinearGradient(0, 0, 0, h || 300);
    g.addColorStop(0, color.replace(')', ',0.3)').replace('rgb', 'rgba'));
    g.addColorStop(1, color.replace(')', ',0)').replace('rgb', 'rgba'));
    return g;
}

function hexToRgba(hex, a) {
    const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    return `rgba(${r},${g},${b},${a})`;
}

// ==========================
// DAILY COST CHART
// ==========================
function renderDailyCost(type) {
    const data = chartDataStore.dailyCost;
    if (!data) return;
    destroyChart('dailyCostChart');
    const el = document.getElementById('dailyCostChart');
    const ctx2d = el.getContext('2d');
    const gradient = ctx2d.createLinearGradient(0, 0, 0, 320);
    gradient.addColorStop(0, 'rgba(6,214,160,0.25)');
    gradient.addColorStop(1, 'rgba(6,214,160,0)');

    let chartType = type === 'area' ? 'line' : (type === 'radar' ? 'radar' : type);
    let config = {
        type: chartType,
        data: {
            labels: data.map(d => d.date),
            datasets: [{
                label: 'Daily Cost ($)',
                data: data.map(d => d.cost),
                borderColor: '#06d6a0',
                backgroundColor: (type === 'area' || type === 'line') ? gradient : hexToRgba('#06d6a0', 0.6),
                fill: type === 'area',
                tension: 0.4,
                pointRadius: type === 'line' || type === 'area' ? 0 : 3,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: '#06d6a0',
                borderWidth: 2.5,
                borderRadius: type === 'bar' ? 8 : 0,
                barThickness: type === 'bar' ? undefined : undefined,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
                legend: { display: false },
                tooltip: { ...TOOLTIP_STYLE, callbacks: { label: c => '$ ' + c.parsed.y.toFixed(2) } }
            },
            interaction: { intersect: false, mode: 'index' },
            scales: chartType !== 'radar' ? {
                x: { grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } },
                y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { callback: v => '$'+v, font: { size: 10 } } }
            } : {}
        }
    };
    chartInstances['dailyCostChart'] = new Chart(el, config);
}

fetch(apiUrl('/api/daily-costs')).then(r => r.json()).then(data => {
    chartDataStore.dailyCost = data;
    renderDailyCost('line');
});

// ==========================
// SERVICE COST CHART
// ==========================
function renderServiceCost(type) {
    const data = chartDataStore.serviceCost;
    if (!data) return;
    destroyChart('serviceCostChart');
    const el = document.getElementById('serviceCostChart');
    let config;
    if (type === 'bar') {
        config = {
            type: 'bar',
            data: {
                labels: data.map(d => d.service.replace('Amazon ','').replace('AWS ','')),
                datasets: [{
                    data: data.map(d => d.cost),
                    backgroundColor: PALETTE.slice(0, data.length).map(c => hexToRgba(c, 0.7)),
                    borderColor: PALETTE.slice(0, data.length),
                    borderWidth: 1.5, borderRadius: 8,
                }]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: { legend: { display: false }, tooltip: { ...TOOLTIP_STYLE, callbacks: { label: c => '$ ' + c.parsed.x.toFixed(2) } } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { callback: v => '$'+v, font: { size: 10 } } },
                    y: { grid: { display: false }, ticks: { font: { size: 9 } } }
                }
            }
        };
    } else {
        config = {
            type: type,
            data: {
                labels: data.map(d => d.service.replace('Amazon ','').replace('AWS ','')),
                datasets: [{
                    data: data.map(d => d.cost),
                    backgroundColor: PALETTE.slice(0, data.length),
                    borderWidth: type === 'polarArea' ? 1 : 0, hoverOffset: 12,
                    borderColor: type === 'polarArea' ? PALETTE.slice(0, data.length) : undefined,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: type === 'doughnut' ? '68%' : 0,
                animation: { animateRotate: true, duration: 1000, easing: 'easeOutQuart' },
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 }, padding: 6, usePointStyle: true, pointStyle: 'circle' } },
                    tooltip: { ...TOOLTIP_STYLE, callbacks: { label: c => c.label + ': $' + c.parsed.toFixed(2) } }
                }
            }
        };
    }
    chartInstances['serviceCostChart'] = new Chart(el, config);
}

fetch(apiUrl('/api/service-costs')).then(r => r.json()).then(data => {
    chartDataStore.serviceCost = data;
    renderServiceCost('doughnut');
});

// ==========================
// REGION COST CHART
// ==========================
function renderRegionCost(type) {
    const data = chartDataStore.regionCost;
    if (!data) return;
    destroyChart('regionCostChart');
    const el = document.getElementById('regionCostChart');
    const labels = data.map(d => d.region);
    const values = data.map(d => d.cost);

    if (type === 'doughnut' || type === 'polarArea') {
        chartInstances['regionCostChart'] = new Chart(el, {
            type: type,
            data: { labels, datasets: [{ data: values, backgroundColor: PALETTE.slice(0, data.length), borderWidth: 1, hoverOffset: 10 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: { duration: 900, easing: 'easeOutQuart' },
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 9 }, padding: 5, usePointStyle: true } },
                    tooltip: { ...TOOLTIP_STYLE, callbacks: { label: c => c.label + ': $' + c.parsed.toFixed(2) } }
                }
            }
        });
    } else {
        const isHorizontal = (type === 'horizontalBar');
        chartInstances['regionCostChart'] = new Chart(el, {
            type: 'bar',
            data: {
                labels, datasets: [{
                    label: 'Cost ($)', data: values,
                    backgroundColor: data.map((_, i) => hexToRgba(PALETTE[i % PALETTE.length], 0.65)),
                    borderColor: data.map((_, i) => PALETTE[i % PALETTE.length]),
                    borderWidth: 1.5, borderRadius: 8, barThickness: 22,
                }]
            },
            options: {
                indexAxis: isHorizontal ? 'y' : 'x',
                responsive: true, maintainAspectRatio: false,
                animation: { duration: 800, easing: 'easeOutQuart' },
                plugins: { legend: { display: false }, tooltip: { ...TOOLTIP_STYLE, callbacks: { label: c => '$ ' + (isHorizontal ? c.parsed.x : c.parsed.y).toFixed(2) } } },
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { callback: v => '$'+v, font: { size: 10 } } },
                    y: { grid: { display: false }, ticks: { font: { size: 9 } } }
                }
            }
        });
    }
}

fetch(apiUrl('/api/region-costs')).then(r => r.json()).then(data => {
    chartDataStore.regionCost = data;
    renderRegionCost('horizontalBar');
});

// ==========================
// DAILY SERVICE COST
// ==========================
function renderDailyService(type) {
    const data = chartDataStore.dailyService;
    if (!data) return;
    destroyChart('dailyServiceChart');
    const el = document.getElementById('dailyServiceChart');
    const isStacked = type === 'stackedArea' || type === 'stackedBar';
    const chartType = (type === 'stackedBar') ? 'bar' : 'line';

    const datasets = data.services.map((svc, i) => {
        const c = PALETTE[i % PALETTE.length];
        return {
            label: svc.service.replace('Amazon ','').replace('AWS ',''),
            data: svc.costs,
            borderColor: c,
            backgroundColor: chartType === 'bar' ? hexToRgba(c, 0.65) : hexToRgba(c, 0.15),
            fill: type === 'stackedArea',
            tension: 0.3, pointRadius: 0, pointHoverRadius: 4, borderWidth: 1.5,
            borderRadius: chartType === 'bar' ? 4 : 0,
        };
    });
    if (data.other && data.other.some(v => v > 0)) {
        datasets.push({
            label: 'Other', data: data.other, borderColor: '#6c757d',
            backgroundColor: chartType === 'bar' ? 'rgba(108,117,125,0.5)' : 'rgba(108,117,125,0.1)',
            fill: type === 'stackedArea', tension: 0.3, pointRadius: 0, borderWidth: 1,
        });
    }
    chartInstances['dailyServiceChart'] = new Chart(el, {
        type: chartType,
        data: { labels: data.dates, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 900, easing: 'easeOutQuart' },
            plugins: {
                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 }, padding: 8, usePointStyle: true, pointStyle: 'circle' } },
                tooltip: { mode: 'index', intersect: false, ...TOOLTIP_STYLE, callbacks: { label: c => c.dataset.label + ': $' + c.parsed.y.toFixed(2) } }
            },
            interaction: { intersect: false, mode: 'index' },
            scales: {
                x: { stacked: isStacked, grid: { display: false }, ticks: { maxTicksLimit: 10, font: { size: 10 } } },
                y: { stacked: isStacked, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { callback: v => '$'+v, font: { size: 10 } } }
            }
        }
    });
}

fetch(apiUrl('/api/daily-service-costs')).then(r => r.json()).then(data => {
    chartDataStore.dailyService = data;
    renderDailyService('stackedArea');
});

// ==========================
// MONTHLY COST CHART
// ==========================
function renderMonthlyCost(type) {
    const data = chartDataStore.monthlyCost;
    if (!data) return;
    destroyChart('monthlyCostChart');
    const el = document.getElementById('monthlyCostChart');
    const totals = data.totals || [];
    const labels = totals.map(d => d.month);
    const values = totals.map(d => d.cost);
    const ctx2d = el.getContext('2d');

    let chartType = type === 'area' ? 'line' : (type === 'radar' ? 'radar' : type);
    const gradient = ctx2d.createLinearGradient(0, 0, 0, 320);
    gradient.addColorStop(0, 'rgba(76,201,240,0.25)');
    gradient.addColorStop(1, 'rgba(76,201,240,0)');

    const bgColors = totals.map((d, i, arr) => {
        if (i === 0) return hexToRgba('#06d6a0', 0.7);
        return d.cost > arr[i-1].cost ? hexToRgba('#ef476f', 0.7) : hexToRgba('#06d6a0', 0.7);
    });
    const borderColors = totals.map((d, i, arr) => {
        if (i === 0) return '#06d6a0';
        return d.cost > arr[i-1].cost ? '#ef476f' : '#06d6a0';
    });

    chartInstances['monthlyCostChart'] = new Chart(el, {
        type: chartType,
        data: {
            labels,
            datasets: [{
                label: 'Monthly Cost ($)',
                data: values,
                backgroundColor: type === 'bar' ? bgColors : (type === 'area' ? gradient : hexToRgba('#4cc9f0', 0.5)),
                borderColor: type === 'bar' ? borderColors : '#4cc9f0',
                borderWidth: type === 'bar' ? 1.5 : 2.5,
                borderRadius: type === 'bar' ? 8 : 0,
                barThickness: type === 'bar' ? 36 : undefined,
                fill: type === 'area',
                tension: 0.4,
                pointRadius: chartType === 'line' ? 4 : (chartType === 'radar' ? 3 : 0),
                pointBackgroundColor: '#4cc9f0',
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
                legend: { display: false },
                tooltip: { ...TOOLTIP_STYLE, callbacks: { label: c => '$ ' + c.parsed.y.toFixed(2) } }
            },
            scales: chartType !== 'radar' ? {
                x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                y: { grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { callback: v => '$'+v, font: { size: 10 } } }
            } : {}
        }
    });
}

fetch('/api/monthly-costs').then(r => r.json()).then(data => {
    chartDataStore.monthlyCost = data;
    renderMonthlyCost('bar');
});

// ==========================
// CHART TYPE SWITCHER ENGINE
// ==========================
const renderMap = {
    'dailyCostChart': renderDailyCost,
    'serviceCostChart': renderServiceCost,
    'regionCostChart': renderRegionCost,
    'dailyServiceChart': renderDailyService,
    'monthlyCostChart': renderMonthlyCost,
};

document.querySelectorAll('.chart-type-switcher').forEach(switcher => {
    const chartId = switcher.dataset.chartId;
    switcher.querySelectorAll('.chart-switch-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switcher.querySelectorAll('.chart-switch-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            const type = this.dataset.type;
            if (renderMap[chartId]) renderMap[chartId](type);
        });
    });
});

// ==========================
// 3D TILT EFFECT ON KPI CARDS
// ==========================
document.querySelectorAll('[data-tilt]').forEach(card => {
    card.addEventListener('mousemove', e => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const cx = rect.width / 2;
        const cy = rect.height / 2;
        const rotateX = ((y - cy) / cy) * -8;
        const rotateY = ((x - cx) / cx) * 8;
        card.style.transform = `perspective(800px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateZ(10px)`;
        // Move glow
        const glow = card.querySelector('.kpi-glow');
        if (glow) {
            glow.style.left = x + 'px';
            glow.style.top = y + 'px';
            glow.style.opacity = '1';
        }
    });
    card.addEventListener('mouseleave', () => {
        card.style.transform = 'perspective(800px) rotateX(0) rotateY(0) translateZ(0)';
        const glow = card.querySelector('.kpi-glow');
        if (glow) glow.style.opacity = '0';
    });
});

// ==========================
// ANIMATED NUMBER COUNTERS
// ==========================
function animateCounters() {
    document.querySelectorAll('.kpi-counter').forEach(el => {
        const target = parseFloat(el.dataset.target);
        if (!target || isNaN(target)) return;
        const duration = 1500;
        const start = performance.now();
        const prefix = el.textContent.trim().startsWith('$') ? '$' : '';

        function step(now) {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            const eased = 1 - Math.pow(1 - progress, 4); // easeOutQuart
            const current = target * eased;
            el.textContent = prefix + current.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (progress < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    });
}

// ---- Intersection Observer for scroll-triggered counters ----
const counterObserver = new IntersectionObserver(entries => {
    entries.forEach(e => { if (e.isIntersecting) { animateCounters(); counterObserver.disconnect(); } });
}, { threshold: 0.3 });
document.querySelectorAll('.kpi-counter').forEach(el => counterObserver.observe(el));

// ==========================
// FLOATING PARTICLES BACKGROUND
// ==========================
(function initParticles() {
    const canvas = document.createElement('canvas');
    canvas.id = 'particleBg';
    canvas.style.cssText = 'position:fixed;inset:0;z-index:-2;pointer-events:none;';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    let w, h, particles = [];

    function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
    resize();
    window.addEventListener('resize', resize);

    for (let i = 0; i < 60; i++) {
        particles.push({
            x: Math.random() * w, y: Math.random() * h,
            vx: (Math.random() - 0.5) * 0.3, vy: (Math.random() - 0.5) * 0.3,
            r: Math.random() * 2 + 0.5,
            color: PALETTE[Math.floor(Math.random() * 5)],
            alpha: Math.random() * 0.15 + 0.05,
        });
    }

    function draw() {
        ctx.clearRect(0, 0, w, h);
        particles.forEach(p => {
            p.x += p.vx; p.y += p.vy;
            if (p.x < 0) p.x = w; if (p.x > w) p.x = 0;
            if (p.y < 0) p.y = h; if (p.y > h) p.y = 0;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = p.color;
            ctx.globalAlpha = p.alpha;
            ctx.fill();
        });
        // Draw connections
        ctx.globalAlpha = 0.03;
        ctx.strokeStyle = '#06d6a0';
        ctx.lineWidth = 0.5;
        for (let i = 0; i < particles.length; i++) {
            for (let j = i + 1; j < particles.length; j++) {
                const dx = particles[i].x - particles[j].x;
                const dy = particles[i].y - particles[j].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if (dist < 150) {
                    ctx.beginPath();
                    ctx.moveTo(particles[i].x, particles[i].y);
                    ctx.lineTo(particles[j].x, particles[j].y);
                    ctx.stroke();
                }
            }
        }
        ctx.globalAlpha = 1;
        requestAnimationFrame(draw);
    }
    draw();
})();
</script>
{% endblock %}
